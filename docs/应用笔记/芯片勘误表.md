# 芯片勘误表

## FlexCAN 

### ERR005829  FlexCAN不传输在仲裁过程中的特定时刻启用传输的消息

#### 描述
FlexCAN不传输在仲裁过程中的特定时刻启用传输的消息。出现该问题需要满足以下条件:  
•只配置一个消息缓冲区来传输  
•在仲裁过程中的特定时钟期间，使消息缓冲区能够传输的写操作(写在控制/状态字上)发生。  
•在此仲裁过程发生后，总线进入Idle状态，并且总线上没有收到新消息。  

例如:  
1. 消息缓冲区13在RxIntermission上被停用(将0x0写入CODE字段)
控制/状态字)[先写入CODE]  
2. 重新配置ID和data字段  
3. 启用消息缓冲区13在BusIdle上传输(在CODE字段上写0xC)[第二次写入CODE]  
4. CAN总线保持在空闲状态  
5. 没有从任何消息缓冲区写入控制/状态。 

在第二次写入CODE(步骤3)期间，写入必须在仲裁进程扫描当前消息缓冲区13之前一个时钟发生。在本例中，它不检测新代码
(0xC)并且没有安排新的仲裁。  
只有当消息流量停止并且can总线在上述事件序列之后进入Idle状态时，才能检测到问题。  
如果符合以下任何条件，则没有问题:  
•任何消息缓冲区(Tx或Rx)都被重新配置(通过写入其CS字段)
幕间休息。  
•有其他配置的消息缓冲区要传输。  
•任何外部节点发送的新传入消息在中场休息字段之后开始。   

#### 受影响芯片
芯片1 芯片2 芯片3

#### 解决办法
要传输CAN帧，CPU必须通过执行以下标准的5个步骤以生成用于传输的消息缓冲区：  
1. 检查是否设置了相应的中断位并清除它  
2. 如果消息缓冲区处于活动状态（传输挂起），请将中止代码（0b1001）写入控制/状态字的CODE字段，以请求中止传输。通过轮询IFLAG寄存器或中断请求（如果由相应的IMASK启用）来等待断言相应的IFLAG。然后读回CODE字段以检查传输是否已中止或已传输。如果需要向后兼容（MCR[AEN]位被否定），只需将非活动代码（0b1000）写入CODE字段以停用消息缓冲区，但随后可能会在不通知的情况下传输挂起的帧。  
3. 写ID字  
4. 写入数据字节  
5. 写入控制/状态字的DLC、Control和CODE字段以激活消息缓冲区  
6. 该解决方法包括执行两个额外的步骤：  
7. 将第一个有效邮箱保留为非活动邮箱（CODE = 0b1000）。如果禁用了RX FIFO，则此邮箱必须是邮件缓冲区0。否则，可以使用芯片参考手册FlexCAN章节中的“RX FIFO滤波器”表找到第一个有效邮箱  
8. 将两次非活动代码（0b1000）写入第一个有效邮箱  

### ERR006032  当CAN总线处于总线空闲状态时，正在传输的消息缓冲区中止或停用时，具有错误ID或有效负载的帧被传输到CAN总线中

#### 描述
如果在FlexCAN处于总线空闲状态时配置了一个或多个消息缓冲区（MB）进行传输，并且选择传输的MB在开始传输的确切时刻被中止或停用，则FlexCAN模块可能会传输不正确的信息。这将导致FlexCAN发送语法正确的消息，但使用不正确的ID或数据字段。CRC信息将基于不正确的数据（以防数据受到影响）进行计算，且帧中的所有其他字段都将是正确的。  
在传输一帧时，问题发生的概率仅限于一个CAN位，在非常特定的多起事件组合下：  
1. Bug事件可能发生在每帧一个特定的CAN位中  
2. CAN总线必须处于总线空闲状态  
3. 必须触发CPU以配置一个或多个MB以在总线空闲状态下进行传输    
4. 在步骤3中开始配置的短时间内，必须触发CPU，通过停用删除刚刚配置的 MB。  

综上所述，发生的概率非常低，大约为1/1000万。此外，在正常应用中不太可能发生配置MB，然后在短时间内停用相同MB的过程。  
在实践中，如果CPU保证传输配置的任何MB将在下一帧中止或停用，则没有问题  

#### 受影响芯片
芯片1 芯片2 芯片3

#### 解决办法
当CAN总线处于总线空闲状态时，用户可以通过阻止对传输进行MB配置来避免该错误。FlexCAN调试寄存器中有一些位可用于确定CAN总线何时处于空闲状态。
该调试寄存器位于：FlexCAN调试1寄存器（CAN_DBG1）- Base + 0x0058。CAN_DBG1寄存器的CAN有限状态机（CFSM）位监控FlexCAN的内部状态。CFSM是CAN_DBG1寄存器中六个最低位。CAN位数（CBN）是CAN_DBG1寄存器中bit位3至7处的五位长字段，用于指示给定CFSM状态值中的当前位数。  
CAN_DBG1.CFSM = 0x0000_003F   
CAN_DBG1.CBN = 0x1F00_0000  
需要查找几个内部状态值，下面列出了它们相应的CFSM值
RXINTERMISSION - 0x2F  
TXINTERMISSION - 0x14   
BUSIDLE - 0x02  

必须执行以下过程来配置MB传输：  
1. 禁用所有中断  
2. 读取CAN_DBG1.CFSM和CAN_DBG1.CBN字段  
3. 检查CFSM值是否为BUSIDLE、RXINTERMISSION或TXINTERMISSION  
对于后两个值，还要检查CBN值是否为3，以确定配对条件RXINTERMISSION bit 3或TXINTERMISSION bit 3，并按如下所述进行处理。  
3.1 如果CAN_DBG1字段指示 BUSIDLE，则等待N个CPU时钟  
3.2 否则，若CAN_DBG1如果字段指示RXINTERMISSION位3或TXINTERMISSION位3，则等待CFSM与RXINTERMISSION或TXINTERMISSION不同  
4. 将0x0写入CS字的代码字段  
5. 使能所有中断  
6. 写入ID字  
7. 写入DATA字  
8. 将0xC写入CS字的代码字段  

### ERR009527 传输中止机制可能无法正常工作

#### 描述
灵活控制器局域网（FlexCAN）无法中止传输帧，在以下情况下，中止过程可能保持待定状态：  
1. 如果在FlexCAN接收远程帧时发生挂起的中止请求  
2. 当帧在帧接收后的重载帧期间中止时  
3. 当FlexCAN刚刚开始传输时就请求中止  
4. 当发生冻结模式请求且FlexCAN刚刚开始传输时  

#### 受影响芯片
芯片1 芯片2 芯片3

#### 解决办法
使用邮箱停用机制而不是传输中止机制。模块配置寄存器的中止使能（AEN）位可以保持清除状态，并且中止代码值“0b1001”不能被写入消息缓冲区控制和状态字的CODE字段。  

### ERR009595 如果在总线关闭状态下进入冻结模式或低功耗模式，则帧可能损坏

#### 描述
如果模块配置寄存器（MCR）的冻结使能位（FRZ）被置位，并且在总线关闭状态期间通过置位MCR寄存器的停止位（HALT）来请求冻结模式，则退出总线关闭条件后的传输将被损坏。仅当传输在冻结模式请求之前处于挂起状态时，才会出现此问题。此外，如果请求低功耗模式而不是冻结模式，也会出现同样的问题。  

#### 受影响芯片
芯片1 芯片2 芯片3

#### 解决办法
解决方法取决于在请求冻结模式或低功耗模式之前是否发生Bus-Off条件。  
进入冻结模式的过程：  
1. 在模块控制寄存器（MCR）中置位冻结使能位（FRZ）  
2. 检查MCR寄存器的模块禁用位（MDIS）是否置位。如果置位，清除MDIS位  
3. 轮询MCR寄存器，直到MCR中的低功耗模式确认（LPMACK）位被清除（软件实现的超时为两个CAN位长度）  
4. 读取错误和状态1寄存器（ESR1）中的故障限制状态（FLTCONF）字段，以检查FlexCAN是否处于总线关闭状态。如果是，请转到步骤5A。否则，请转到步骤5B。
5A.  置位MCR寄存器的软件复位位（（SOFTRST）  
6A.  轮询MCR寄存器，直到软件复位（SOFTRST）位被清除（软件实现的超时为两个CAN位长度  
7A.  轮询MCR寄存器，直到置位冻结确认（FRZACK）位（软件实现的超时为两个CAN位长度）  
8A.  重新配置MCR寄存器  
9A.  重新配置所有中断掩码寄存器（IMASKn）  

5B.  置位MCR寄存器的Halt FlexCAN（HALT）位  
6B.  轮询MCR寄存器，直到置位冻结确认（FRZACK）位（软件实现的超时为178个CAN位长度）  
Note！步骤4和步骤5B之间的时间必须小于1353个CAN位周期。  

进入低功耗模式的步骤：  
1. 进入冻结模式（执行过程 A）  
2. 请求低功耗模式  
3. 轮询MCR寄存器，直到MCR寄存器的低功耗模式确认（LPMACK）位被置1（软件实现的超时为两个CAN位长度）  

## ADC
### 错误号
### 错误号

## BKP
### 错误号
### 错误号

## CRC
### 错误号
### 错误号

## DBG
### 错误号
### 错误号